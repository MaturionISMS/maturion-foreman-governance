name: Locked Section Protection Gate

on:
  pull_request:
    paths:
      - '.github/agents/**/*.agent.md'
      - '.github/agents/**/*.md'
      - '.agent'
  push:
    branches:
      - main
    paths:
      - '.github/agents/**/*.agent.md'
      - '.github/agents/**/*.md'
      - '.agent'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-locked-sections:
    name: Validate Locked Section Integrity
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check diffs
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyYAML
      
      - name: Check for locked section modifications
        id: check_modifications
        run: |
          python .github/scripts/check_locked_sections.py \
            --mode=detect-modifications \
            --base-ref=${{ github.event.pull_request.base.sha || 'main' }} \
            --head-ref=${{ github.sha }}
      
      - name: Validate locked section metadata
        id: validate_metadata
        run: |
          python .github/scripts/check_locked_sections.py \
            --mode=validate-metadata \
            --contracts-dir=.github/agents
      
      - name: Verify protection registry sync
        id: verify_registry
        run: |
          python .github/scripts/check_locked_sections.py \
            --mode=verify-registry \
            --contracts-dir=.github/agents \
            --registry-file=governance/contracts/protection-registry.md
      
      - name: Check for CS2 approval
        if: steps.check_modifications.outputs.locked_sections_modified == 'true'
        run: |
          # Check if PR has locked-section-approved label or CS2 approval comment
          APPROVED_LABEL=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name | select(. == "locked-section-approved")')
          
          if [ -z "$APPROVED_LABEL" ]; then
            echo "‚ùå LOCKED SECTION MODIFICATION DETECTED WITHOUT APPROVAL"
            echo ""
            echo "One or more locked sections were modified in this PR."
            echo "Locked sections require explicit CS2 (Johan Ras/Maturion) approval."
            echo ""
            echo "Modified Lock IDs:"
            cat /tmp/modified_lock_ids.txt || echo "  (See check_locked_sections.py output above)"
            echo ""
            echo "To proceed:"
            echo "1. Create a locked section change request using governance/templates/LOCKED_SECTION_CHANGE_REQUEST_TEMPLATE.md"
            echo "2. Submit to governance/agent-contract-instructions/pending/"
            echo "3. Obtain CS2 approval"
            echo "4. Add 'locked-section-approved' label to this PR"
            echo "5. Reference the approved change request in PR description"
            echo ""
            echo "Authority: governance/canon/AGENT_CONTRACT_PROTECTION_PROTOCOL.md"
            exit 1
          fi
          
          echo "‚úÖ Locked section modification approved (locked-section-approved label present)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate gate summary
        if: always()
        run: |
          echo "## üîí Locked Section Protection Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_modifications.outputs.locked_sections_modified }}" == "true" ]; then
            echo "### ‚ö†Ô∏è Locked Section Modifications Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR modifies locked sections. CS2 approval required." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Modified Lock IDs:" >> $GITHUB_STEP_SUMMARY
            cat /tmp/modified_lock_ids.txt >> $GITHUB_STEP_SUMMARY || echo "  (See logs above)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ No Locked Section Modifications" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR does not modify any locked sections." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Metadata Validation**: ${{ steps.validate_metadata.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry Sync**: ${{ steps.verify_registry.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Authority**: \`governance/canon/AGENT_CONTRACT_PROTECTION_PROTOCOL.md\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Comment on PR (if modifications detected)
        if: steps.check_modifications.outputs.locked_sections_modified == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const modifiedLocks = process.env.MODIFIED_LOCKS || 'See gate logs';
            const body = `## üîí Locked Section Protection Gate
            
            ‚ö†Ô∏è **This PR modifies locked agent contract sections**
            
            Modified Lock IDs:
            ${modifiedLocks}
            
            **Required Actions:**
            1. Create locked section change request using \`governance/templates/LOCKED_SECTION_CHANGE_REQUEST_TEMPLATE.md\`
            2. Submit to \`governance/agent-contract-instructions/pending/\`
            3. Obtain CS2 (Johan Ras/Maturion) approval
            4. Add \`locked-section-approved\` label to this PR
            5. Reference approved change request in PR description
            
            **Authority**: \`governance/canon/AGENT_CONTRACT_PROTECTION_PROTOCOL.md\`
            
            ---
            
            This gate enforces constitutional protection of governance-critical agent contract requirements.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        env:
          MODIFIED_LOCKS: ${{ steps.check_modifications.outputs.modified_locks }}
