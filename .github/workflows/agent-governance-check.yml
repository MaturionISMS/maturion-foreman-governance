name: Agent Governance Validation

on:
  pull_request:
    paths:
      - ".agent"
      - ".github/workflows/**"
  push:
    branches:
      - main

jobs:
  validate-agent:
    name: Validate .agent Contract
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: Agent Governance & Contract"
          echo ""
          
          # Look for PREHANDOVER_PROOF with agent governance validation documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -Eqi "Agent.*(Governance|Contract)" PREHANDOVER_PROOF.md; then
            echo "✅ Found PREHANDOVER_PROOF.md with Agent Governance validation"
            echo "✅ ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -Eqi "Agent.*(Governance|Contract)" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "✅ Found PREHANDOVER_PROOF with Agent Governance validation"
            echo "✅ ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️  No evidence-based validation found - proceeding with validation"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate .agent Contract
        if: steps.evidence_check.outputs.skip_execution != 'true'
        shell: bash
        run: |
          set -e
          export PATH="/usr/bin:/bin:/usr/local/bin:$PATH"
          
          echo "=== Validate Agent Contract Files ==="
          
          # Find all agent contract files
          AGENT_FILES=$(find .github/agents -name "*.md" 2>/dev/null || echo ".agent")
          if [ -f ".agent" ]; then
            AGENT_FILES="$AGENT_FILES .agent"
          fi
          
          if [ -z "$AGENT_FILES" ]; then
            echo "❌ No agent contract files found"
            exit 1
          fi
          
          echo "Found agent contract files:"
          echo "$AGENT_FILES"
          echo ""
          
          YAML_ERRORS=0
          
          for FILE in $AGENT_FILES; do
            if [ ! -f "$FILE" ]; then
              continue
            fi
            
            echo "=== Validating: $FILE ==="
            
            # Extract YAML frontmatter (between first two --- markers)
            FRONTMATTER=$(awk '/^---$/{if(++count==2) exit; if(count==1) next} count==1' "$FILE")
            
            if [ -z "$FRONTMATTER" ]; then
              echo "❌ No YAML frontmatter found in $FILE"
              YAML_ERRORS=$((YAML_ERRORS + 1))
              continue
            fi
            
            # Write frontmatter to temp file for validation
            TEMP_YAML=$(mktemp)
            echo "$FRONTMATTER" > "$TEMP_YAML"
            
            # Validate YAML frontmatter only
            echo "Validating YAML frontmatter..."
            if /usr/bin/yamllint -d "{extends: default, rules: {line-length: {max: 200}}}" "$TEMP_YAML" 2>&1; then
              echo "✅ Valid YAML frontmatter"
            else
              echo "❌ Invalid YAML frontmatter"
              YAML_ERRORS=$((YAML_ERRORS + 1))
            fi
            
            rm "$TEMP_YAML"
            
            # Validate required keys in frontmatter
            echo "Checking required governance keys..."
            REQUIRED_KEYS=(
              "governance:"
              "canon:"
              "repository:"
              "path: /governance/canon"
              "reference:"
            )
            
            for KEY in "${REQUIRED_KEYS[@]}"; do
              if ! echo "$FRONTMATTER" | /usr/bin/grep -q "$KEY"; then
                echo "❌ Missing required governance binding: $KEY"
                YAML_ERRORS=$((YAML_ERRORS + 1))
              fi
            done
            
            if [ $YAML_ERRORS -eq 0 ]; then
              echo "✅ Canonical governance binding present"
            fi
            
            # Validate required top-level sections exist
            echo "Checking required sections..."
            REQUIRED_SECTIONS=(
              "^agent:"
              "^governance:"
              "^scope:"
              "^capabilities:"
              "^constraints:"
            )
            
            for SECTION in "${REQUIRED_SECTIONS[@]}"; do
              if ! echo "$FRONTMATTER" | /usr/bin/grep -Eq "$SECTION"; then
                echo "⚠️ Missing recommended section: $SECTION"
              fi
            done
            
            echo ""
          done
          
          if [ $YAML_ERRORS -gt 0 ]; then
            echo "❌ Agent contract validation failed: $YAML_ERRORS error(s)"
            exit 1
          fi
          
          echo "✅ All agent contract files validated successfully"
