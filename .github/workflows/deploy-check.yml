# GitHub Actions Workflow for Deploy Check
# Production and Deployment Validation
#
# This workflow validates that code is ready for production deployment
# by running build checks and deployment simulations.

name: Deploy Check - Production Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  deploy-validation:
    name: Production Deployment Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Production Build
        id: build
        run: |
          echo "Running production build..."
          npm run build
      
      - name: Verify Build Artifacts
        id: artifacts
        run: |
          echo "Verifying build artifacts..."
          
          # Check if .next directory exists
          if [ ! -d ".next" ]; then
            echo "❌ Build failed - .next directory not found"
            exit 1
          fi
          
          # Check if static files exist
          if [ ! -d ".next/static" ]; then
            echo "❌ Build failed - static assets not found"
            exit 1
          fi
          
          echo "✅ Build artifacts verified"
      
      - name: Check Environment Configuration
        id: env-check
        run: |
          echo "Checking environment configuration..."
          
          # Verify .env.example exists
          if [ ! -f ".env.example" ]; then
            echo "⚠️ Warning: .env.example not found"
          else
            echo "✅ Environment template found"
          fi
          
          # Check for required environment variables in example
          if [ -f ".env.example" ]; then
            echo "Environment variables template:"
            cat .env.example
          fi
      
      - name: Run Production Type Check
        id: prod-typecheck
        run: |
          echo "Running production type check (excluding tests)..."
          # Check if production typecheck script exists
          if npm run | grep -q "typecheck:production"; then
            npm run typecheck:production
          else
            echo "No typecheck:production script - using standard typecheck"
            npm run typecheck
          fi
      
      - name: Deployment Readiness Summary
        if: always()
        run: |
          echo "==================================================="
          echo "Deploy Check - Production Validation"
          echo "==================================================="
          echo ""
          echo "✅ Production Build: ${{ steps.build.outcome }}"
          echo "✅ Build Artifacts: ${{ steps.artifacts.outcome }}"
          echo "✅ Environment Config: ${{ steps.env-check.outcome }}"
          echo "✅ Production TypeCheck: ${{ steps.prod-typecheck.outcome }}"
          echo ""
          echo "==================================================="
          
          if [ "${{ steps.build.outcome }}" != "success" ] || \
             [ "${{ steps.artifacts.outcome }}" != "success" ] || \
             [ "${{ steps.prod-typecheck.outcome }}" != "success" ]; then
            echo "❌ DEPLOY CHECK FAILED - Not ready for production"
            exit 1
          else
            echo "✅ DEPLOY CHECK PASSED - Ready for production deployment"
          fi
      
      - name: Comment PR with Deploy Check Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ steps.build.outcome }}';
            const artifactsStatus = '${{ steps.artifacts.outcome }}';
            const envCheckStatus = '${{ steps.env-check.outcome }}';
            const prodTypecheckStatus = '${{ steps.prod-typecheck.outcome }}';
            
            const statusIcon = (status) => status === 'success' ? '✅' : '❌';
            const overallPass = buildStatus === 'success' && 
                               artifactsStatus === 'success' && 
                               prodTypecheckStatus === 'success';
            
            const body = `## ${overallPass ? '✅' : '❌'} Deploy Check - Production Validation
            
            **Status**: ${overallPass ? 'READY FOR DEPLOYMENT' : 'NOT READY'}
            
            ### Deployment Readiness
            
            - ${statusIcon(buildStatus)} **Production Build**: ${buildStatus}
            - ${statusIcon(artifactsStatus)} **Build Artifacts**: ${artifactsStatus}
            - ${statusIcon(envCheckStatus)} **Environment Config**: ${envCheckStatus}
            - ${statusIcon(prodTypecheckStatus)} **Production TypeCheck**: ${prodTypecheckStatus}
            
            ${!overallPass ? `
            ⚠️ **Deployment Blocked**: Fix issues before deploying to production.
            
            Per **Deployment Governance**, all checks must pass for production deployment.
            ` : `
            ✅ All deployment checks passed. Code is ready for production deployment.
            
            **Next Steps**:
            1. Merge PR to main
            2. Request deployment approval from admin
            3. Deploy to production environment
            `}
            
            ---
            *Deployment Governance Enforcement*
            `;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Deploy Check - Production Validation')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

# Deploy Check ensures production readiness
# All validations must pass before deployment
