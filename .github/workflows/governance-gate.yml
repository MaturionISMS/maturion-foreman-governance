# Governance Gate Workflow
# 
# Validates governance file integrity and structure
# Ensures no unauthorized changes to governance policies
# 
# Authority: Supreme - Cannot be bypassed
# Status: Active

name: Governance Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  governance-gate:
    name: Governance Gate Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for evidence collection
      
      - name: Validate Governance Structure
        id: structure
        run: |
          echo "Validating governance directory structure..."
          
          # Check that critical governance directories exist
          MISSING_DIRS=""
          
          if [ ! -d "governance" ]; then
            MISSING_DIRS="$MISSING_DIRS\n- governance/"
          fi
          
          if [ ! -d "governance/philosophy" ]; then
            MISSING_DIRS="$MISSING_DIRS\n- governance/philosophy/"
          fi
          
          if [ ! -d "governance/runbooks" ]; then
            MISSING_DIRS="$MISSING_DIRS\n- governance/runbooks/"
          fi
          
          if [ ! -d "governance/templates" ]; then
            MISSING_DIRS="$MISSING_DIRS\n- governance/templates/"
          fi
          
          if [ -n "$MISSING_DIRS" ]; then
            echo "❌ Critical governance directories missing:"
            echo -e "$MISSING_DIRS"
            exit 1
          fi
          
          echo "✅ All critical governance directories present"
      
      - name: Validate Governance Files
        id: files
        run: |
          echo "Validating critical governance files..."
          
          MISSING_FILES=""
          
          if [ ! -f "governance/philosophy/BYG_DOCTRINE.md" ]; then
            MISSING_FILES="$MISSING_FILES\n- governance/philosophy/BYG_DOCTRINE.md"
          fi
          
          if [ ! -f "governance/philosophy/GOVERNANCE_INCIDENT_RESPONSE_DOCTRINE.md" ]; then
            MISSING_FILES="$MISSING_FILES\n- governance/philosophy/GOVERNANCE_INCIDENT_RESPONSE_DOCTRINE.md"
          fi
          
          if [ ! -f "governance/CONSTITUTION.md" ]; then
            MISSING_FILES="$MISSING_FILES\n- governance/CONSTITUTION.md"
          fi
          
          if [ ! -f "governance/escalation/ESCALATION_POLICY.md" ]; then
            MISSING_FILES="$MISSING_FILES\n- governance/escalation/ESCALATION_POLICY.md"
          fi
          
          if [ -n "$MISSING_FILES" ]; then
            echo "❌ Critical governance files missing:"
            echo -e "$MISSING_FILES"
            exit 1
          fi
          
          echo "✅ All critical governance files present"
      
      - name: Check for Application Code
        id: app_check
        run: |
          echo "Checking for application code artifacts..."
          
          # Check that application directories don't exist
          APP_DIRS=""
          
          for dir in app components lib types tests scripts foreman swarm; do
            if [ -d "$dir" ]; then
              APP_DIRS="$APP_DIRS\n- $dir/"
            fi
          done
          
          if [ -n "$APP_DIRS" ]; then
            echo "⚠️ Application directories found (should not exist in governance repo):"
            echo -e "$APP_DIRS"
            exit 1
          fi
          
          echo "✅ No application code directories found"
      
      - name: Validate Agent Contract Modifications
        id: agent_contract_check
        run: |
          echo "Checking for unauthorized .agent file modifications..."
          
          # Get list of .agent files modified in this PR
          MODIFIED_AGENT_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep -E '\.agent$|\.agent\.md$|/agents/.*\.md$' || true)
          
          if [ -n "$MODIFIED_AGENT_FILES" ]; then
            echo "⚠️ Agent contract files modified in this PR:"
            echo "$MODIFIED_AGENT_FILES"
            echo ""
            echo "⚠️⚠️⚠️ CRITICAL GOVERNANCE VIOLATION WARNING ⚠️⚠️⚠️"
            echo ""
            echo "Agent contract files (.agent, .agent.md, .github/agents/*.md) may ONLY be modified by:"
            echo "  - Agent Contract Administrator (.github/agents/agent-contract-administrator.md)"
            echo "  - Operating under CS2-approved instructions from governance/agent-contract-instructions/"
            echo ""
            echo "Bypassing this protocol is a CATASTROPHIC governance violation."
            echo ""
            echo "Required actions:"
            echo "  1. Verify these changes were made by agent-contract-administrator"
            echo "  2. Confirm corresponding approved instruction exists in governance/agent-contract-instructions/approved/"
            echo "  3. Verify instruction has CS2 approval (approved_by field set)"
            echo ""
            echo "If these changes were NOT made by agent-contract-administrator:"
            echo "  - HALT this PR immediately"
            echo "  - ESCALATE to CS2 (Johan Ras)"
            echo "  - REVERT unauthorized changes"
            echo "  - File incident report"
            echo ""
            echo "Authority: governance/canon/AGENT_CONTRACT_MANAGEMENT_PROTOCOL.md"
            echo ""
            echo "⚠️ This check is INFORMATIONAL. Human review REQUIRED for .agent file changes."
          else
            echo "✅ No agent contract files modified"
          fi
      
      - name: Post Gate Report to PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const structureStatus = '${{ steps.structure.outcome }}';
            const filesStatus = '${{ steps.files.outcome }}';
            const appCheckStatus = '${{ steps.app_check.outcome }}';
            const agentContractStatus = '${{ steps.agent_contract_check.outcome }}';
            
            const statusIcon = (status) => status === 'success' ? '✅' : '❌';
            const overallPass = structureStatus === 'success' && 
                               filesStatus === 'success' && 
                               appCheckStatus === 'success';
            
            let comment = '## Governance Gate Validation\n\n';
            comment += `**PR**: #${{ github.event.pull_request.number }}\n`;
            comment += `**Commit**: ${{ github.event.pull_request.head.sha }}\n`;
            comment += `**Status**: ${overallPass ? '✅ PASSED' : '❌ FAILED'}\n\n`;
            
            comment += '### Validation Results\n\n';
            comment += `- ${statusIcon(structureStatus)} **Governance Structure**: ${structureStatus}\n`;
            comment += `- ${statusIcon(filesStatus)} **Governance Files**: ${filesStatus}\n`;
            comment += `- ${statusIcon(appCheckStatus)} **No Application Code**: ${appCheckStatus}\n`;
            comment += `- ${statusIcon(agentContractStatus)} **Agent Contract Check**: ${agentContractStatus}\n\n`;
            
            if (!overallPass) {
              comment += '⚠️ **Governance validation failed**: Fix issues before merging.\n\n';
            }
            
            // Add agent contract warning if contracts were modified
            if (agentContractStatus === 'success') {
              const output = `${{ steps.agent_contract_check.outputs.stdout }}`;
              if (output.includes('Agent contract files modified')) {
                comment += '### ⚠️ Agent Contract Modification Detected\n\n';
                comment += 'This PR modifies agent contract files. **Human review REQUIRED.**\n\n';
                comment += '**Verify**:\n';
                comment += '- [ ] Changes made by agent-contract-administrator\n';
                comment += '- [ ] CS2-approved instruction exists in `governance/agent-contract-instructions/approved/`\n';
                comment += '- [ ] Instruction properly documented with approval evidence\n\n';
                comment += '**Authority**: `governance/canon/AGENT_CONTRACT_MANAGEMENT_PROTOCOL.md`\n\n';
              }
            }
            
            comment += '---\n\n';
            comment += '*This is an automated governance gate validation.*\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Set merge status
        if: always()
        run: |
          if [ "${{ steps.structure.outcome }}" = "success" ] && \
             [ "${{ steps.files.outcome }}" = "success" ] && \
             [ "${{ steps.app_check.outcome }}" = "success" ]; then
            echo "✅ Governance Gate PASSED - Merge allowed"
            exit 0
          else
            echo "❌ Governance Gate FAILED - Merge blocked"
            exit 1
          fi
