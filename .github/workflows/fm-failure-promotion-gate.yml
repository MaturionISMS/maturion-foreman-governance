name: FM Failure Promotion Gate (Governance Required)

on:
  pull_request:
    paths:
      - "architecture/**"
      - ".github/workflows/**"
  push:
    branches:
      - main

jobs:
  fm-failure-promotion-gate:
    name: Enforce governance PR evidence when failures require governance updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve active build
        run: |
          if [ ! -f "architecture/BUILD_ACTIVE" ]; then
            echo "ℹ️ No active build (BUILD_ACTIVE missing). Skipping failure promotion gate."
            echo "SKIP_VALIDATION=true" >> $GITHUB_ENV
            exit 0
          fi
          BUILD_ID="$(cat architecture/BUILD_ACTIVE | tr -d '\r' | tr -d '\n')"
          BUILD_DIR="architecture/builds/${BUILD_ID}"
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          echo "SKIP_VALIDATION=false" >> $GITHUB_ENV

      - name: Enforce governance evidence for failure records
        if: env.SKIP_VALIDATION != 'true'
        run: |
          FAIL_DIR="${BUILD_DIR}/failures"
          if [ ! -d "$FAIL_DIR" ]; then
            echo "✅ No failures directory; nothing to promote."
            exit 0
          fi

          shopt -s nullglob
          FILES=("$FAIL_DIR"/failure-*.md)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "✅ No failure records; nothing to promote."
            exit 0
          fi

          for f in "${FILES[@]}"; do
            req=$(grep "GOVERNANCE_UPDATE_REQUIRED:" "$f" | awk '{print $2}')
            if [ "$req" = "YES" ]; then
              evidence=$(grep "EVIDENCE_LINKS:" "$f" | sed 's/EVIDENCE_LINKS://')
              if [ -z "$evidence" ]; then
                echo "❌ GOVERNANCE BLOCK: $f requires governance update but has no evidence link."
                exit 1
              fi
              if ! echo "$evidence" | grep -E "github.com/.+/pull/|github.com/.+/issues/"; then
                echo "❌ GOVERNANCE BLOCK: $f requires governance update but evidence does not reference a PR/issue."
                exit 1
              fi
            fi
          done

          echo "✅ Failure promotion requirements satisfied"
