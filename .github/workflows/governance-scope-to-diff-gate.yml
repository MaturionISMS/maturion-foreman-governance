name: Governance Scope-to-Diff Enforcement

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read

jobs:
  scope-to-diff-validation:
    name: Validate Scope Declaration Matches Diff
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce scope-to-diff via registry
        run: |
          DOMAIN=$(grep "RESPONSIBILITY_DOMAIN:" governance/scope-declaration.md | cut -d':' -f2 | xargs)

          REGISTRY="governance/canon/RESPONSIBILITY_DOMAIN_REGISTRY.md"
          if ! grep -q "### DOMAIN: $DOMAIN" "$REGISTRY"; then
            echo "❌ GOVERNANCE BLOCK: Responsibility domain '$DOMAIN' is not registered."
            exit 1
          fi

          echo "Using responsibility domain: $DOMAIN"

          ALLOWED=$(awk "/### DOMAIN: $DOMAIN/{flag=1} /Allowed Paths/{getline; while (\$0 ~ /^-/) {print \$2; getline}} flag && /Forbidden Paths/{exit}" "$REGISTRY")
          FORBIDDEN=$(awk "/### DOMAIN: $DOMAIN/{flag=1} /Forbidden Paths/{getline; while (\$0 ~ /^-/) {print \$2; getline}} flag && /Typical Failure/{exit}" "$REGISTRY")

          git fetch origin ${{ github.base_ref }} --depth=1
          FILES=$(git diff --name-only origin/${{ github.base_ref }})

          for FILE in $FILES; do
            for BAD in $FORBIDDEN; do
              # Strip backticks and handle /** pattern
              BAD_CLEAN=$(echo "$BAD" | tr -d '`')
              BAD_CLEAN="${BAD_CLEAN%/**}"
              if [[ "$FILE" == $BAD_CLEAN* ]]; then
                echo "❌ SCOPE VIOLATION: $FILE forbidden for domain $DOMAIN"
                exit 1
              fi
            done

            MATCHED=false
            for OK in $ALLOWED; do
              # Strip backticks and handle /** pattern
              OK_CLEAN=$(echo "$OK" | tr -d '`')
              OK_CLEAN="${OK_CLEAN%/**}"
              if [[ "$FILE" == $OK_CLEAN* ]]; then
                MATCHED=true
              fi
            done

            if [ "$MATCHED" = false ]; then
              echo "❌ SCOPE VIOLATION: $FILE not allowed for domain $DOMAIN"
              exit 1
            fi
          done

          echo "✅ Scope-to-diff enforcement passed via registry"
