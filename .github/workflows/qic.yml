# GitHub Actions Workflow for QIC
# Quality Integrity Contract - TRUE NORTH: One QA, One Build, One Handover
#
# CRITICAL PRINCIPLE:
# This workflow does NOT duplicate QA work. It VERIFIES that Copilot ran QIEL locally.
# The agent runs comprehensive QIEL validation and commits the proof.
# This workflow validates the proof - not re-runs everything.
#
# TRUE NORTH: If local QIEL passes, merge QIEL MUST pass (same config, same rules)
# NO WHITELISTING. NO REGRESSION. QA EVOLVES FORWARD ONLY.

name: QIC - Quality Integrity Contract

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  qic-validation:
    name: Quality Integrity Contract Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Must match QIEL_CONFIG.nodeVersion
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # TRUE NORTH: Run build validation with explicit log paths
      # These logs are used by QIEL for anomaly detection
      - name: Run TypeScript Type Check
        id: typecheck
        run: npm run typecheck 2>&1 | tee /tmp/build.log
      
      - name: Run ESLint
        id: lint
        if: always()
        run: npm run lint 2>&1 | tee /tmp/lint.log
      
      - name: Run Tests
        id: test
        if: always()
        run: npm run test:all 2>&1 | tee /tmp/test.log
      
      # TRUE NORTH: Run QIEL exactly as Copilot does locally
      # This ensures identical validation in both environments
      # ONE CONFIG FILE = ZERO DRIFT
      - name: Run QIEL - Full Validation
        id: qiel
        if: always()
        run: |
          echo "═══════════════════════════════════════════════════════"
          echo "  TRUE NORTH: One QA, One Build, One Handover"
          echo "  Running QIEL from lib/foreman/qiel-config.ts"
          echo "  Same config, same validation, zero drift"
          echo "═══════════════════════════════════════════════════════"
          npm run qiel:full -- \
            --logs-dir /tmp \
            --report ./qiel-report.md \
            --commit-sha ${{ github.sha }} \
            --branch ${{ github.ref_name }}
      
      # CONSTITUTIONAL QA CATEGORIES (CS1-CS5)
      # These tests enforce immutable governance requirements
      # NO PR may merge unless ALL constitutional checks pass
      
      - name: Run Wiring Integrity Tests (WIE)
        id: wiring
        if: always()
        run: npm run test:ui-wiring
      
      - name: Run Guardrail Integrity Tests (CS1)
        id: guardrails
        if: always()
        run: npm run test:guardrails
      
      - name: Run Architecture Integrity Tests (CS2)
        id: architecture
        if: always()
        run: npm run test:architecture
      
      - name: Run Incident Feedback Tests (CS3)
        id: incident
        if: always()
        run: npm run test:incident
      
      - name: Run Performance Integrity Tests (CS5)
        id: performance
        if: always()
        run: npm run test:performance
      
      - name: Upload QIEL Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qiel-report
          path: ./qiel-report.md
          retention-days: 90
      
      - name: QIC Validation Summary
        if: always()
        run: |
          echo "==================================================="
          echo "QIC - Quality Integrity Contract Validation"
          echo "==================================================="
          echo ""
          echo "✅ TypeScript Type Check: ${{ steps.typecheck.outcome }}"
          echo "✅ ESLint: ${{ steps.lint.outcome }}"
          echo "✅ Tests: ${{ steps.test.outcome }}"
          echo "✅ QIEL Full Validation: ${{ steps.qiel.outcome }}"
          echo "✅ Wiring Integrity (WIE): ${{ steps.wiring.outcome }}"
          echo "✅ Guardrail Integrity (CS1): ${{ steps.guardrails.outcome }}"
          echo "✅ Architecture Integrity (CS2): ${{ steps.architecture.outcome }}"
          echo "✅ Incident Feedback (CS3): ${{ steps.incident.outcome }}"
          echo "✅ Performance Integrity (CS5): ${{ steps.performance.outcome }}"
          echo ""
          echo "==================================================="
          
          if [ "${{ steps.typecheck.outcome }}" != "success" ] ||
             [ "${{ steps.lint.outcome }}" != "success" ] ||
             [ "${{ steps.test.outcome }}" != "success" ] ||
             [ "${{ steps.qiel.outcome }}" != "success" ] ||
             [ "${{ steps.wiring.outcome }}" != "success" ] ||
             [ "${{ steps.guardrails.outcome }}" != "success" ] ||
             [ "${{ steps.architecture.outcome }}" != "success" ] ||
             [ "${{ steps.incident.outcome }}" != "success" ] ||
             [ "${{ steps.performance.outcome }}" != "success" ]; then
            echo "❌ QIC FAILED - Constitutional QA violated"
            echo ""
            echo "VIOLATIONS DETECTED:"
            [ "${{ steps.qiel.outcome }}" != "success" ] && echo "  ❌ QIEL validation failed"
            [ "${{ steps.wiring.outcome }}" != "success" ] && echo "  ❌ Wiring Integrity failed"
            [ "${{ steps.guardrails.outcome }}" != "success" ] && echo "  ❌ Guardrail Integrity failed"
            [ "${{ steps.architecture.outcome }}" != "success" ] && echo "  ❌ Architecture Integrity failed"
            [ "${{ steps.incident.outcome }}" != "success" ] && echo "  ❌ Incident Feedback failed"
            [ "${{ steps.performance.outcome }}" != "success" ] && echo "  ❌ Performance Integrity failed"
            echo ""
            echo "TRUE NORTH VIOLATION:"
            echo "If local QIEL passed but merge QIEL failed,"
            echo "this indicates configuration drift - investigate immediately."
            exit 1
          else
            echo "✅ QIC PASSED - All quality standards met"
            echo "✅ TRUE NORTH COMPLIANCE: One QA source verified"
            echo "✅ CONSTITUTIONAL QA: All CS1-CS5 checks passed"
          fi
      
      - name: Comment PR with QIC Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const qielStatus = '${{ steps.qiel.outcome }}';
            const wiringStatus = '${{ steps.wiring.outcome }}';
            const guardrailsStatus = '${{ steps.guardrails.outcome }}';
            const architectureStatus = '${{ steps.architecture.outcome }}';
            const incidentStatus = '${{ steps.incident.outcome }}';
            const performanceStatus = '${{ steps.performance.outcome }}';
            
            const allPassed = qielStatus === 'success' && 
                              wiringStatus === 'success' && 
                              guardrailsStatus === 'success' && 
                              architectureStatus === 'success' && 
                              incidentStatus === 'success' && 
                              performanceStatus === 'success';
            
            const statusIcon = allPassed ? '✅' : '❌';
            
            let reportContent = '';
            const reportPath = './qiel-report.md';
            if (fs.existsSync(reportPath)) {
              reportContent = fs.readFileSync(reportPath, 'utf-8');
              // Truncate if needed
              const maxLength = 50000;
              reportContent = reportContent.length > maxLength 
                ? reportContent.substring(0, maxLength) + '\n\n... (truncated)'
                : reportContent;
            }
            
            const getStatusEmoji = (status) => status === 'success' ? '✅' : '❌';
            
            const body = `## ${statusIcon} QIC - Quality Integrity Contract

**Overall Status**: ${allPassed ? 'PASSED ✅' : 'FAILED ❌'}

### TRUE NORTH: One QA, One Build, One Handover

This validation runs **THE SAME QIEL** that Copilot runs locally.
- **Config:** \`lib/foreman/qiel-config.ts\`
- **Script:** \`npm run qiel:full\`
- **Principle:** Zero drift, zero duplication, zero regression

### Constitutional QA Categories

| Category | Status | Description |
|----------|--------|-------------|
| **QIEL Full Validation** | ${getStatusEmoji(qielStatus)} | Core QA pipeline (lint, build, test) |
| **WIE - Wiring Integrity** | ${getStatusEmoji(wiringStatus)} | UI → API → Context → Model flow |
| **CS1 - Guardrail Integrity** | ${getStatusEmoji(guardrailsStatus)} | Immutable governance files protected |
| **CS2 - Architecture Integrity** | ${getStatusEmoji(architectureStatus)} | Architecture changes require approval |
| **CS3 - Incident Feedback** | ${getStatusEmoji(incidentStatus)} | Deployment verification loop |
| **CS5 - Performance Integrity** | ${getStatusEmoji(performanceStatus)} | No TODOs, no lazy fixes |

${reportContent ? `
### QIEL Report

${reportContent}
` : ''}

${!allPassed ? `
⚠️ **Action Required**: Constitutional QA violations detected.

**Failed Checks:**
${qielStatus !== 'success' ? '- ❌ QIEL Full Validation\n' : ''}${wiringStatus !== 'success' ? '- ❌ Wiring Integrity (WIE)\n' : ''}${guardrailsStatus !== 'success' ? '- ❌ Guardrail Integrity (CS1)\n' : ''}${architectureStatus !== 'success' ? '- ❌ Architecture Integrity (CS2)\n' : ''}${incidentStatus !== 'success' ? '- ❌ Incident Feedback (CS3)\n' : ''}${performanceStatus !== 'success' ? '- ❌ Performance Integrity (CS5)\n' : ''}
**If local QIEL passed but this failed**, investigate configuration drift immediately.
This violates TRUE NORTH principles.
` : `
✅ **Ready to Merge**: All quality checks passed.

TRUE NORTH COMPLIANCE:
- ✅ One QA source of truth verified
- ✅ Zero configuration drift
- ✅ One-time build handover complete

CONSTITUTIONAL QA COMPLIANCE:
- ✅ All CS1-CS5 checks passed
- ✅ Wiring integrity verified
- ✅ Guardrails protected
- ✅ Architecture governance enforced
- ✅ Incident feedback loop validated
- ✅ Performance standards met
`}

---
*Quality Integrity Contract - TRUE NORTH Enforcement*
*Executed via: npm run qiel:full (same as local validation)*
`;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('QIC - Quality Integrity Contract')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

# TRUE NORTH PRINCIPLES:
# 1. ONE CONFIG FILE (lib/foreman/qiel-config.ts) = ZERO DRIFT
# 2. ONE QA VALIDATION (qiel:full) = ZERO DUPLICATION
# 3. NO WHITELISTING = CONTINUOUS EVOLUTION
# 4. NO REGRESSION = FORWARD PROGRESS ONLY
# 5. ONE-TIME BUILD = TRUST LOCAL VALIDATION
